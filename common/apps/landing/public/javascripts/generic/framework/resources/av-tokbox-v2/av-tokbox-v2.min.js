define("container",["require","jquery","log"],function(e){function o(e){return this.mode}function u(e){if(i.indexOf(e)==-1){n.error("set_mode: unrecognized container mode : "+e);return}var r=t(this.div());for(var s=0;s<i.length;s++){var o="av-"+i[s];if(e==i[s]){r.hasClass(o)||r.addClass(o);continue}r.hasClass(o)&&r.removeClass(o)}n.info("set mode = "+e+", for #"+this.id()),this.mode=e}function a(e){return i.indexOf(e)==-1?(n.error("in_mode: unrecognized container mode : "+e),!1):this.mode==e}function f(){return this.type}function l(e){if(s.indexOf(e)===-1){n.error('set_type: unknown type "'+e+'" for container #'+this.id());return}this.type=e}function c(e){this.conn_id=e}function h(e,t){y.call(this,"connected")}function p(){var e=t(this.div()),r=e.attr("class").split(/\s+/);t.each(r,function(t,n){e.removeClass(n)}),e.hasClass("av-container")||e.addClass("av-container"),e.hasClass("av-shunya")||e.addClass("av-shunya"),this.mode="shunya",this.type=null,this.state="initial",this.conn_id=null,this.stream=null,n.info("gave up container "+this.id())}function d(e){t(this.div()).append("<span></span>"),t(this.div()).addClass("av-error");var n=t(this.div()).find("span");n.addClass("av-error"),this.state="error"}function v(){var e=t(this.div());e.hasClass("av-shunya")&&e.removeClass("av-shunya"),e.hasClass("av-visible")||e.addClass("av-visible")}function m(){var e=t(this.div());e.hasClass("av-visible")&&e.removeClass("av-visible"),e.hasClass("av-shunya")||e.addClass("av-shunya")}function g(e){var i=t(this.div());if(r.indexOf(e)==-1)return n.error("change_state: unrecognized container state ("+e+") requested"),!1;for(var s=0;s<r.length;s++){var o="av-"+r[s];if(e!=r[s]){i.hasClass(o)&&i.removeClass(o);continue}i.hasClass(o)||i.addClass(o)}return this.state=e,!0}function y(e){var t=this.state;g.call(this,e)&&(e==="connected"||e==="streaming"?v.call(this):m.call(this),n.info("[ #"+this.id()+' ]changed state from "'+t+'" to "'+e+'"'))}function b(){var e=this.div();return t(e).hasClass("av-primary")?!0:!1}function w(){y.call(this,"streaming")}var t=e("jquery"),n=e("log")("av-container","info"),r=["initial","connected","streaming","error"],i=["shunya","primary","secondary","screenshare","full","pip"],s=["video-primary","video-secondary","screenshare-local","screenshare-remote"];return function(e){this.id_=t(e).attr("id"),this.div_=e,this.mode="shunya",this.type=null,this.state="initial",this.conn_id=null,this.stream=null,this.div=function(){return this.div_},this.id=function(){return this.id_},this.set_type=l,this.get_type=f,this.set_mode=u,this.get_mode=o,this.in_mode=a,this.set_connection_id=c,this.stream_destroyed=h,this.giveup=p,this.show_error=d,this.change_state=y,this.in_mode_primary=b,this.reveal_video=w}}),define("container-pool",["require","jquery","log","./container"],function(e){function f(e){t.each(t("#av-containers .av-container"),function(e,i){var s=t(i).attr("id"),a=o;Object.keys(u).length||(a=u),a[s]=new r(i),n.info('probe_layout: adding container "#'+s+'" to av pool')})}var t=e("jquery"),n=e("log")("av-container-pool","info"),r=e("./container"),i={},s,o={},u={},a={};return i.init=function(e,t,n,r){return s=t.anchor,f(s),!0},i.alloc_container=function(e,t){var r=o;if(e==="screenshare-local"||e==="screenshare-remote")r=u;var i=Object.keys(r);if(!i.length)return n.error("no free containers left"),null;var s=r[i[0]];return s.set_type(e),s.set_mode(t),s.change_state("connected"),a[i[0]]=s,delete r[i[0]],n.info("allocated container #"+i[0]+", type ("+e+"), mode ("+t+")"),s},i.giveup_container=function(e){var t=o,r=e.id(),i=e.get_type();if(!a[r]){n.error("attempt to giveup non-used container (id = #"+r+")");return}if(i==="screenshare-local"||i==="screenshare-remote")t=u;t[r]=e,delete a[r],e.giveup()},i.get_containers_by_mode=function(e){var t=[];for(var n in a){var r=a[n];r.get_mode()==e&&t.push(r)}return t},i.free_count=function(e){var t=o;return e==="screenshare"&&(t=u),Object.keys(t).length},i.get_container_by_id=function(e,t){if(e!="used"&&!0)throw"pool.get_container_by_id: invalid argument (pool = "+e+")";return e==="used"?a[t]:o[t]?o[t]:u[t]},i.get_used_list=function(){var e=[];for(var t in a)e.push(a[t]);return e},i}),define("menu",["require","jquery","log"],function(e){var t=e("jquery"),n=e("log")("av-menu","info"),r={},i,s;r.init=function(e,t){return i=e,s=t,null};var o=null,u=!1;return r.screenshare={set_handler:function(e){o=e,u=!0,t("#widget-nav li#nav-screenshare a").on("click",e),t("#widget-nav li#nav-screenshare").removeClass("disabled")},enable:function(){if(o){if(u)return;t("#widget-nav li#nav-screenshare a").on("click",o),t("#widget-nav li#nav-screenshare").removeClass("disabled")}},disable:function(){u=!1,t("#widget-nav li#nav-screenshare a").off("click"),t("#widget-nav li#nav-screenshare").addClass("disabled")}},r}),define("layout",["require","jquery","events","log","./container","./container-pool","./menu"],function(e){function p(e,n){t.each(t("#av-containers .av-container"),function(e,s){var o=t(s).attr("id");n[o]=new i(s),r.info('probe_layout: adding container "#'+o+'" to av pool')})}function d(){n.bind("framework:layout",w,"av-layout"),n.bind("av:connection",b,"av-layout"),t(".av-container").on("click",function(e){var n=e.currentTarget,i=t(n).attr("id"),o=s.get_container_by_id("used",i);if(!o){r.error("clicked_container is null. Ignoring click.");return}switch(h){case"av-default":v(o);break;case"av-fullscreen":m(o);break;case"av-tiled":break;default:r.error('unknown layout "'+h+'". Handling as default.'),v(o)}})}function v(e){var t,n;if(e.in_mode("screenshare")){t=s.get_containers_by_mode("primary")[0],e.set_mode("full"),t.set_mode("pip");return}if(e.in_mode("secondary")){t=s.get_containers_by_mode("primary")[0],t.set_mode("secondary"),e.set_mode("primary");return}if(e.in_mode("full")){n=s.get_containers_by_mode("pip")[0],n.set_mode("primary"),e.set_mode("screenshare");return}}function m(e){var t,n;if(e.in_mode("secondary")){t=s.get_containers_by_mode("primary")[0],e.set_mode("primary"),t.set_mode("secondary");return}}function g(e,t){var n;switch(e){case"av-fullscreen":n={"video-primary":"primary","video-secondary":"secondary","screenshare-local":"secondary","screenshare-remote":"secondary"};break;case"av-tiled":n={"video-primary":"secondary","video-secondary":"secondary","screenshare-local":"secondary","screenshare-remote":"secondary"};break;case"av-default":n={"video-primary":"primary","video-secondary":"secondary","screenshare-local":"secondary","screenshare-remote":"screenshare"};break;default:n={"video-primary":"primary","video-secondary":"secondary","screenshare-local":"secondary","screenshare-remote":"screenshare"}}return n[t]}function b(e,n){var r=t("#av-indicator");e==="incoming-connection"&&y++,e==="incoming-media"&&y--,y<0&&(y=0),y?t(r).css("display","block"):t(r).css("display","none")}function w(e,t){var n=e;s.get_used_list().forEach(function(e,t,r){var i=e.get_mode(),s=e.get_type(),o=g(n,s);o!=i&&e.set_mode(o)}),h=n;return}var t=e("jquery"),n=e("events"),r=e("log")("av-layout","info"),i=e("./container"),s=e("./container-pool"),o=e("./menu"),u={},a,f,l={},c={},h="av-default";u.init=function(e,n,r,i){var s="av-tokbox",o=e.template(s);return f=n.anchor,o?(t(f).append(o()),d(),null):'av-layout: template "'+s+'" not found'},u.get_container=function(e){var t=g(h,e),n=s.alloc_container(e,t);if(e==="screenshare-local"||e==="screenshare-remote")s.free_count("screenshare")||o.screenshare.disable();return n},u.giveup_container=function(e,t){var n=e.get_type();w(h,null),s.giveup_container(e),(n==="screenshare-remote"||n==="screenshare-local")&&o.screenshare.enable();return},u.show_error=function(e,t){return e.show_error(t)},u.stream_destroyed=function(e,t){e.stream_destroyed(t)},u.reveal_video=function(e){e.reveal_video()};var y=0;return u}),define("tokbox",["require","//static.opentok.com/v2/js/opentok.min.js","log","jquery"],function(e,t,n,r){function c(e){if(!f)return i.error("exception: ("+e.code+")"+e.title+": "+e.message);f(e.code,e.title,e.message)}function p(e,t){h[e]=t}function d(e){delete h[e]}var i=n("av-tokbox","info"),s=window.OT,o={},u,a;s.on("exception",c),o.init=function(e){var t=r.Deferred();return s.checkSystemRequirements()===0?(t.reject("OT: no WebRTC support. Aborting."),t.promise()):(u=s.initSession(e.key,e.sessionid),u.off(),t.resolve(e),t.promise())},o.set_handlers=function(e,t){var n=r.Deferred();return u.on({sessionConnected:e.sessionConnected,sessionDisconnected:e.sessionDisconnected,sessionReconnecting:e.sessionReconnecting,sessionReconnected:e.sessionReconnected,connectionCreated:function(t){var n=t.connection,r=n.connectionId,s=n.data;p(r,n);var o=r==u.connection.connectionId?!0:!1;i.info("connection created: "+r+" (local = "+o+"), data: "+n.data),e.connectionCreated(r,s,o)},connectionDestroyed:function(t){var n=t.connection,r=n.connectionId;i.info("connection destroyed: "+r+", reason: "+t.reason),d(r),e.connectionDestroyed(r,t.reason)},streamCreated:function(t){var n=t.stream,r=n.streamId,s=n.connection.connectionId;i.info("stream created: (conn_id = "+s+")"+r+", type: "+n.videoType+", stream: ",n),e.streamCreated(r,n)},streamDestroyed:function(t){var n=t.stream,r=n.streamId;i.info("stream destroyed: "+r+", reason: "+t.reason),e.streamDestroyed(r,t.reason)},streamPropertyChanged:function(t){var n=t.changedProperty,r=t.oldValue,s=t.newValue,o=t.stream.streamId;i.error("stream property changed: "+o+", property: "+n+", changed from ("+r+") --> ("+s+")"),e.streamPropertyChanged(o,n,r,s)}}),n.resolve(t),n.promise()},o.connect=function(e){var t=e.token,n=r.Deferred();return u.connect(t,function(t){if(t)return n.reject(t);n.resolve(e)}),n.promise()},o.init_publisher=function(e,t,n,o){var u=r.Deferred();n||i.error("no div supplied !");var f={width:"100%",height:"100%",audioFallbackEnabled:!0,fitMode:"contain",frameRate:30,insertMode:"append",maxResolution:{width:1280,height:720},name:e,publishAudio:!0,publishVideo:!0,resolution:o&&o.resolution||"320x240",showControls:!1,style:{audioLevelDisplayMode:"off",backgroundImageURI:"off",nameDisplayMode:"off",buttonDisplayMode:"off"}};return o&&o.videoSource&&(f.videoSource=o.videoSource),a=s.initPublisher(n,o,function(e){return e?u.reject(e):u.resolve(t,a)}),r(n).attr("style",""),u.promise()},o.publish=function(e){var t=r.Deferred();return e||(e=a),u.publish(e,function(n){if(n)return i.error("publish: err = "+n),t.reject(n);t.resolve(e)}),t.promise()};var f;o.set_exception_handler=function(e){f=e},o.set_pub_handlers=function(e){for(var t in e)a.on(t,e[t])},o.subscribe=function(e,t,n){var s=r.Deferred();t||i.error("no div supplied !");var o={style:{nameDisplayMode:"off",buttonDisplayMode:"off",videoDisabledDisplayMode:"auto",audioLevelDisplayMode:"off"},fitmode:"contain",insertMode:"append",width:"100%",height:"100%"},a=u.subscribe(e,t,o,function(e){if(e)return s.reject(e);a.on("audioLevelUpdated",function(e){}),s.resolve(a)});return s.promise()},o.checkScreenSharingCapability=s.checkScreenSharingCapability,o.registerScreenSharingExtension=s.registerScreenSharingExtension;var l={1004:"Authentication error",1005:"Invalid Session ID",1006:"Connect Failed",1007:"Connect Rejected",1008:"Connect Time-out",1009:"Security Error",1010:"Not Connected",1011:"Invalid Parameter",1013:"Connection Failed",1014:"API Response Failure",1026:"Terms of Service Violation: Export Compliance",1500:"Unable to Publish",1520:"Unable to Force Disconnect",1530:"Unable to Force Unpublish",1535:"Force Unpublish on Invalid Stream",2e3:"Internal Error",2010:"Report Issue Failure"},h={};return o}),define("local-media",["require","jquery","log","./layout","./tokbox","./container"],function(e){function l(e){i.set_pub_handlers({accessAllowed:c,accessDenied:h,accessDialogOpened:p,accessDialogClosed:d,destroyed:v,mediaStopped:m,streamCreated:g,streamDestroyed:y}),this.resolve(e)}function c(e){}function h(e){n.error("it seems, access to local media was denied by the user. TODO: Show a modal error here.")}function p(e){}function d(e){}function v(e){n.info("publisher element destroyed: reason: "+e.reason)}function m(e){}function g(e){var t=e.stream;r.reveal_video(a),f.emit("incoming-media",{connection_id:null,stream_id:t.stream_id,stream:t})}function y(e){n.info("streamDestroyed: ev = ",e),r.stream_destroyed(a,e.reason)}var t=e("jquery"),n=e("log")("av-local","info"),r=e("./layout"),i=e("./tokbox"),s=e("./container"),o={},u,a,f;return o.init=function(e,n,r,s){var o=t.Deferred(),u=e.identity.vc_id,c=n.div();return a=n,f=r,i.init_publisher(u,s,c).then(l.bind(o,s),o.reject.bind(o)),o.promise()},o.start=function(e){var n=t.Deferred();return i.publish().then(n.resolve.bind(n,e),n.reject.bind(n)),n.promise()},o.container=function(){return a},o}),define("session",["require","jquery","events","log","./local-media","./layout","./tokbox"],function(e){function d(e,t,n){f.notify.alert("AV Error ("+e+") "+t,n,"danger",{non_dismissable:!0,button:{}})}function v(e){r.info("TODO : sessionConnected:",e)}function m(e){f.notify.alert("AV: Session Disconnected",e.reason,"danger",{non_dismissable:!0,button:{}})}function g(e){r.info("TODO : sessionReconnected",e)}function y(e){r.info("TODO : sessionConnected",e)}function b(e,t,n){var r;h[e]||(h[e]={streams:{}}),n||(n=!1),h[e].local=n,h[e].vc_id=t,c.emit("incoming-connection",{connection_id:e,vc_id:t,local:n});if(h[e].pending){for(var i in h[e].pending){var s=h[e].pending[i];E(i,s)}delete h[e].pending}}function w(e,t){if(!h[e]){r.error("connectionDestroyed: no mapping for connection id "+e+" (reason = "+t+")");return}r.info("connection destroyed: "+e+", reason = "+t);for(var n in h[e].streams){var i=h[e].streams[n];S(n,i)}delete h[e]}function E(e,t){var n={},i=t.connection.connectionId;if(!h[i]){r.info('race-condition: "streamCreated" called before "connectionCreated". Handling it.'),h[i].pending||(h[i]={pending:{}}),h[i].pending[e]=t;return}var u=h[i].local,a;switch(t.videoType){case"screen":a=u?"screenshare-local":"screenshare-remote";break;case"camera":a=u?"video-primary":"video-secondary";break;default:r.error('Unknown stream type "'+t.videoType+'", conn_id: '+i+", stream_id: "+e),a="video-secondary"}var l=s.get_container(a);if(!l){f.notify.alert("Internal TODO message","Ran out of containers ! Implement audio only containers.","danger",{non_dismissable:!1,button:{cancel:function(){}}});return}l.set_connection_id(i),p[e]={connection_id:i},h[i].streams[e]={stream:t,container:l},o.subscribe(t,l.div(),n).then(function(n){s.reveal_video(l),c.emit("incoming-media",{connection_id:i,stream_id:e,stream:t})},function(e){s.show_error(l,e),c.emit("incoming-media",{err:e,connection_id:i})})}function S(e,t){if(!p[e])return;var n=p[e].connection_id,i=h[n].streams[e].container;r.info("stream destroyed: stream_id: "+e+", reason = "+t),s.giveup_container(i,t),delete h[n].streams[e],delete p[e]}var t=e("jquery"),n=e("events"),r=e("log")("av-session","info"),i=e("./local-media"),s=e("./layout"),o=e("./tokbox"),u={},a,f,l={sessionConnected:v,sessionDisconnected:m,sessionReconnecting:g,sessionReconnected:y,connectionCreated:b,connectionDestroyed:w,streamCreated:E,streamDestroyed:S},c=n.emitter("av:connection","av:session.js");u.init=function(e,t,n){return o.set_exception_handler(d),null},u.start=function(e,n){var r=t.Deferred();a=n,f=e;var u=s.get_container("video-primary");return o.init(n).then(o.set_handlers.bind(o,l),r.reject.bind(r)).then(o.connect,r.reject.bind(r)).then(i.init.bind(null,e,u,c),r.reject.bind(r)).then(i.start,r.reject.bind(r)),r.promise()},u.info=function(e,t,n){r.info("TODO : session.info called but not implemented")};var h={},p={};return u}),define("screenshare",["require","jquery","log","./layout","remodal","./menu","./tokbox"],function(e){function c(){var e=t.Deferred();return o.registerScreenSharingExtension("chrome",f.chromeextensionid),h().then(function(t){if(t)return d(e);m(e)},function(t){a.notify.alert("Screenshare Error",t,"danger",{non_dismissable:!0,button:{}}),e.reject(t)}),e.promise()}function h(){var e=t.Deferred();return o.checkScreenSharingCapability(function(t){!t.supported||t.extensionRegistered===!1?e.reject("screensharing not supported"):t.extensionInstalled===!1?e.resolve(!1):e.resolve(!0)}),e.promise()}function d(e){var i=a.identity.vc_id;p=r.get_container("screenshare-local");if(!p){a.notify.alert("Screenshare Error","Ran out of free containers","danger",{non_dismissable:!1,button:{}}),e.reject("ran out of free containers !");return}t(p.div()).append('<div id="av-ot-screenshare-wrap"></div>');var s=t("div#av-ot-screenshare-wrap");o.init_publisher(i,null,s[0],{videoSource:"screen"}).then(function(t,n){return l=n,y(),o.publish(l),r.reveal_video(p),e.resolve()},function(i){return a.notify.alert("Screenshare Error",i,"danger",{non_dismissable:!1,button:{}}),t(p.div()).find("div#av-ot-screenshare-wrap").remove(),r.giveup_container(p),p=null,n.error("screenshare: failed to initialize publisher: ",i),e.reject(i)})}function m(e){var n="https://chrome.google.com/webstore/detail/"+f.chromeextensionid;v=t("[data-remodal-id=browser-extension-download]").remodal({closeOnConfirm:!1}),t("a[href='chromeSSExtPath']").attr("href",n),v.open()}function g(){v.close()}function y(){o.set_pub_handlers({accessAllowed:b,accessDenied:w,accessDialogOpened:E,accessDialogClosed:S,destroyed:x,mediaStopped:T,streamCreated:N,streamDestroyed:C})}function b(e){}function w(e){n.error("it seems, access to local media was denied by the user. TODO: Show a modal error here.")}function E(e){}function S(e){}function x(e){n.info("publisher element destroyed: reason: "+e.reason)}function T(e){}function N(e){var t=e.stream;r.reveal_video(p)}function C(e){n.info("streamDestroyed: ev = ",e),r.giveup_container(p,e.reason)}var t=e("jquery"),n=e("log")("av-screenshare","info"),r=e("./layout"),i=e("remodal"),s=e("./menu"),o=e("./tokbox"),u={},a,f,l;u.init=function(e,n){return a=e,f=n,t(".remodal-confirm").click(g),s.screenshare.set_handler(c),null};var p,v;return u}),define("av-tokbox-v2",["require","jquery","jade","log","framework","./session","./layout","./screenshare","./menu","./container-pool"],function(e){var t=e("jquery");window.jade=e("jade");var n=e("log")("av-main-v2","info"),r=e("framework"),i=e("./session"),s=e("./layout"),o=e("./screenshare"),u=e("./menu"),a=e("./container-pool"),f={},l=r.handle("av-tokbox-v2");return f.init=function(e,n,r){var f=t.Deferred(),c=s.init(l,e,n,r);return c?(d.reject(c),d.promise()):(c=i.init(),c?(d.reject(c),d.promise()):(u.init(l,n),a.init(l,e,n,r),c=o.init(l,n),c?(d.reject(c),d.promise()):(f.resolve(),f.promise())))},f.start=function(e){return i.start(l,e)},f.info=function(e,t,n){},f}),require([""]);