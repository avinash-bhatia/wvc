define("container",["require","jquery","log"],function(e){function o(e){return this.mode}function u(e){if(i.indexOf(e)==-1){n.error("set_mode: unrecognized container mode : "+e);return}for(var r=0;r<i.length;r++){if(e==i[r]){t(this.div()).addClass("av-"+i[r]);continue}t(this.div()).removeClass("av-"+i[r])}n.info("set mode = "+e+", for #"+this.id()),this.mode=e}function a(e){return i.indexOf(e)==-1?(n.error("in_mode: unrecognized container mode : "+e),!1):this.mode==e}function f(){return this.type}function l(e){if(s.indexOf(e)===-1){n.error('set_type: unknown type "'+e+'" for container #'+this.id());return}this.type=e}function c(e){this.conn_id=e}function h(e,t){y.call(this,"connected")}function p(){var e=t(this.div()),n=e.attr("class").split(/\s+/);t.each(n,function(t,n){e.removeClass(n)}),e.hasClass("av-container")||e.addClass("av-container"),e.hasClass("av-shunya")||e.addClass("av-shunya"),this.mode="shunya",this.type=null,this.state="initial",this.conn_id=null,this.stream=null}function d(e){t(this.div()).append("<span></span>"),t(this.div()).addClass("av-error");var n=t(this.div()).find("span");n.addClass("av-error"),this.state="error"}function v(){var e=t(this.div());e.hasClass("av-shunya")&&e.removeClass("av-shunya"),e.hasClass("av-visible")||e.addClass("av-visible")}function m(){var e=t(this.div());e.hasClass("av-visible")&&e.removeClass("av-visible"),e.hasClass("av-shunya")||e.addClass("av-shunya")}function g(e){var i=t(this.div());if(r.indexOf(e)==-1)return n.error("change_state: unrecognized container state ("+e+") requested"),!1;for(var s=0;s<r.length;s++){if(e!=r[s]){i.removeClass("av-"+r[s]);continue}i.addClass("av-"+e)}return this.state=e,!0}function y(e){var t=this.state;g.call(this,e)&&(e==="connected"||e==="streaming"?v.call(this):m.call(this),n.info("[ #"+this.id()+' ]changed state from "'+t+'" to "'+e+'"'))}function b(){var e=this.div();return t(e).hasClass("av-primary")?!0:!1}function w(){y.call(this,"streaming")}var t=e("jquery"),n=e("log")("av-container","info"),r=["initial","connected","streaming","error"],i=["shunya","primary","secondary","screenshare","full","pip"],s=["video-primary","video-secondary","screenshare-local","screenshare-remote"];return function(e){this.id_=t(e).attr("id"),this.div_=e,this.mode="shunya",this.type=null,this.state="initial",this.conn_id=null,this.stream=null,this.div=function(){return this.div_},this.id=function(){return this.id_},this.set_type=l,this.get_type=f,this.set_mode=u,this.get_mode=o,this.in_mode=a,this.set_connection_id=c,this.stream_destroyed=h,this.giveup=p,this.show_error=d,this.change_state=y,this.in_mode_primary=b,this.reveal_video=w}}),define("container-pool",["require","jquery","log","./container"],function(e){function a(e,i){t.each(t("#av-containers .av-container"),function(e,s){var o=t(s).attr("id");i[o]=new r(s),n.info('probe_layout: adding container "#'+o+'" to av pool')})}var t=e("jquery"),n=e("log")("av-container-pool","info"),r=e("./container"),i={},s,o={},u={};return i.init=function(e,t,n,r){return s=t.anchor,a(s,o),!0},i.alloc_container=function(e,t){var r=Object.keys(o);if(!r.length)return n.error("no free containers left"),null;var i=o[r[0]];return i.set_type(e),i.set_mode(t),i.change_state("connected"),u[r[0]]=i,delete o[r[0]],n.info("allocated container #"+r[0]+", type ("+e+"), mode ("+t+")"),i},i.giveup_container=function(e){var t=e.id();if(!u[t]){n.error("attempt to giveup non-used container (id = #"+t+")");return}o[t]=e,delete u[t],e.giveup()},i.get_containers_by_mode=function(e){var t=[];for(var n in u){var r=u[n];r.get_mode()==e&&t.push(r)}return t},i.get_container_by_id=function(e,t){if(e!="used"&&!0)throw"pool.get_container_by_id: invalid argument (pool = "+e+")";var n=e==="used"?u:o;return n[t]},i.get_used_list=function(){var e=[];for(var t in u)e.push(u[t]);return e},i}),define("layout",["require","jquery","events","log","./container","./container-pool"],function(e){function h(e,n){t.each(t("#av-containers .av-container"),function(e,s){var o=t(s).attr("id");n[o]=new i(s),r.info('probe_layout: adding container "#'+o+'" to av pool')})}function p(){n.bind("framework:layout",g,"av-layout"),t(".av-container").on("click",function(e){var n=e.currentTarget,i=t(n).attr("id"),o=s.get_container_by_id("used",i);if(!o){r.error("clicked_container is null. Ignoring click.");return}switch(c){case"av-default":d(o);break;case"av-fullscreen":v(o);break;case"av-tiled":break;default:r.error('unknown layout "'+c+'". Handling as default.'),d(o)}})}function d(e){var t,n;if(e.in_mode("screenshare")){t=s.get_containers_by_mode("primary")[0],e.set_mode("full"),t.set_mode("pip");return}if(e.in_mode("secondary")){t=s.get_containers_by_mode("primary")[0],t.set_mode("secondary"),e.set_mode("primary");return}if(e.in_mode("full")){n=s.get_containers_by_mode("pip")[0],n.set_mode("primary"),e.set_mode("screenshare");return}}function v(e){var t,n;if(e.in_mode("secondary")){t=s.get_containers_by_mode("primary")[0],e.set_mode("primary"),t.set_mode("secondary");return}}function m(e,t){var n;switch(e){case"av-fullscreen":n={"video-primary":"primary","video-secondary":"secondary","screenshare-local":"secondary","screenshare-remote":"secondary"};break;case"av-tiled":n={"video-primary":"secondary","video-secondary":"secondary","screenshare-local":"secondary","screenshare-remote":"secondary"};break;case"av-default":n={"video-primary":"primary","video-secondary":"secondary","screenshare-local":"secondary","screenshare-remote":"screenshare"};break;default:n={"video-primary":"primary","video-secondary":"secondary","screenshare-local":"secondary","screenshare-remote":"screenshare"}}return n[t]}function g(e,t){var n=e;s.get_used_list().forEach(function(e,t,r){var i=e.get_mode(),s=e.get_type(),o=m(n,s);o!=i&&e.set_mode(o)}),c=n;return}var t=e("jquery"),n=e("events"),r=e("log")("av-layout","info"),i=e("./container"),s=e("./container-pool"),o={},u,a,f={},l={},c="av-default";return o.init=function(e,n,r,i){var s="av-tokbox",o=e.template(s);return a=n.anchor,o?(t(a).append(o()),p(),null):'av-layout: template "'+s+'" not found'},o.get_container=function(e){var t=m(c,e);return s.alloc_container(e,t)},o.giveup_container=function(e,t){return s.giveup_container(e)},o.show_error=function(e,t){return e.show_error(t)},o.stream_destroyed=function(e,t){e.stream_destroyed(t)},o.reveal_video=function(e){e.reveal_video()},o}),define("tokbox",["require","//static.opentok.com/v2/js/opentok.min.js","log","jquery"],function(e,t,n,r){function c(e){if(!f)return i.error("exception: ("+e.code+")"+e.title+": "+e.message);f(e.code,e.title,e.message)}function p(e,t){h[e]=t}function d(e){delete h[e]}var i=n("av-tokbox","info"),s=window.OT,o={},u,a;s.on("exception",c),o.init=function(e){var t=r.Deferred();return s.checkSystemRequirements()===0?(t.reject("OT: no WebRTC support. Aborting."),t.promise()):(u=s.initSession(e.key,e.sessionid),u.off(),t.resolve(e),t.promise())},o.set_handlers=function(e,t){var n=r.Deferred();return u.on({sessionConnected:e.sessionConnected,sessionDisconnected:e.sessionDisconnected,sessionReconnecting:e.sessionReconnecting,sessionReconnected:e.sessionReconnected,connectionCreated:function(t){var n=t.connection,r=n.connectionId;p(r,n);var s=r==u.connection.connectionId?!0:!1;i.info("connection created: "+r+" (local = "+s+"), data: "+n.data),e.connectionCreated(r,s)},connectionDestroyed:function(t){var n=t.connection,r=n.connectionId;i.info("connection destroyed: "+r+", reason: "+t.reason),d(r),e.connectionDestroyed(r,t.reason)},streamCreated:function(t){var n=t.stream,r=n.streamId,s=n.connection.connectionId;i.info("stream created: (conn_id = "+s+")"+r+", type: "+n.videoType+", stream: ",n),e.streamCreated(r,n)},streamDestroyed:function(t){var n=t.stream,r=n.streamId;i.info("stream destroyed: "+r+", reason: "+t.reason),e.streamDestroyed(r,t.reason)},streamPropertyChanged:function(t){var n=t.changedProperty,r=t.oldValue,s=t.newValue,o=t.stream.streamId;i.error("stream property changed: "+o+", property: "+n+", changed from ("+r+") --> ("+s+")"),e.streamPropertyChanged(o,n,r,s)}}),n.resolve(t),n.promise()},o.connect=function(e){var t=e.token,n=r.Deferred();return u.connect(t,function(t){if(t)return n.reject(t);n.resolve(e)}),n.promise()},o.init_publisher=function(e,t,n,o){var u=r.Deferred();n||i.error("no div supplied !");var f={width:"100%",height:"100%",audioFallbackEnabled:!0,fitMode:"contain",frameRate:30,insertMode:"append",maxResolution:{width:1280,height:720},name:e,publishAudio:!0,publishVideo:!0,resolution:o&&o.resolution||"320x240",showControls:!1,style:{audioLevelDisplayMode:"off",backgroundImageURI:"off",nameDisplayMode:"off",buttonDisplayMode:"off"}};return o&&o.videoSource&&(f.videoSource=o.videoSource),a=s.initPublisher(n,o,function(e){return e?u.reject(e):u.resolve(t,a)}),r(n).attr("style",""),u.promise()},o.publish=function(e){var t=r.Deferred();return e||(e=a),u.publish(e,function(n){if(n)return i.error("publish: err = "+n),t.reject(n);t.resolve(e)}),t.promise()};var f;o.set_exception_handler=function(e){f=e},o.set_pub_handlers=function(e){for(var t in e)a.on(t,e[t])},o.subscribe=function(e,t,n){var s=r.Deferred();t||i.error("no div supplied !");var o={style:{nameDisplayMode:"off",buttonDisplayMode:"off",videoDisabledDisplayMode:"auto",audioLevelDisplayMode:"off"},fitmode:"contain",insertMode:"append",width:"100%",height:"100%"},a=u.subscribe(e,t,o,function(e){if(e)return s.reject(e);a.on("audioLevelUpdated",function(e){}),s.resolve()});return s.promise()},o.checkScreenSharingCapability=s.checkScreenSharingCapability,o.registerScreenSharingExtension=s.registerScreenSharingExtension;var l={1004:"Authentication error",1005:"Invalid Session ID",1006:"Connect Failed",1007:"Connect Rejected",1008:"Connect Time-out",1009:"Security Error",1010:"Not Connected",1011:"Invalid Parameter",1013:"Connection Failed",1014:"API Response Failure",1026:"Terms of Service Violation: Export Compliance",1500:"Unable to Publish",1520:"Unable to Force Disconnect",1530:"Unable to Force Unpublish",1535:"Force Unpublish on Invalid Stream",2e3:"Internal Error",2010:"Report Issue Failure"},h={};return o}),define("local-media",["require","jquery","log","./layout","./tokbox","./container"],function(e){function f(e){i.set_pub_handlers({accessAllowed:l,accessDenied:c,accessDialogOpened:h,accessDialogClosed:p,destroyed:d,mediaStopped:v,streamCreated:m,streamDestroyed:g}),this.resolve(e)}function l(e){}function c(e){n.error("it seems, access to local media was denied by the user. TODO: Show a modal error here.")}function h(e){}function p(e){}function d(e){n.info("publisher element destroyed: reason: "+e.reason)}function v(e){}function m(e){var t=e.stream;r.reveal_video(a)}function g(e){r.stream_destroyed(a,e.reason)}var t=e("jquery"),n=e("log")("av-local","info"),r=e("./layout"),i=e("./tokbox"),s=e("./container"),o={},u,a;return o.init=function(e,n,r){var s=t.Deferred(),o=e.identity.vc_id,u=n.div();return a=n,i.init_publisher(o,r,u).then(f.bind(s,r),s.reject.bind(s)),s.promise()},o.start=function(e){var n=t.Deferred();return i.publish().then(n.resolve.bind(n,e),n.reject.bind(n)),n.promise()},o.container=function(){return a},o}),define("session",["require","jquery","log","./local-media","./layout","./tokbox"],function(e){function h(e,t,n){a.notify.alert("AV Error ("+e+") "+t,n,"danger",{non_dismissable:!0,button:{}})}function p(e){n.info("TODO : sessionConnected:",e)}function d(e){a.notify.alert("AV: Session Disconnected",e.reason,"danger",{non_dismissable:!0,button:{}})}function v(e){n.info("TODO : sessionReconnected",e)}function m(e){n.info("TODO : sessionConnected",e)}function g(e,t){var n;l[e]||(l[e]={streams:{}}),t||(t=!1),l[e].local=t;if(l[e].pending){for(var r in l[e].pending){var i=l[e].pending[r];b(r,i)}delete l[e].pending}}function y(e,t){if(!l[e]){n.error("connectionDestroyed: no mapping for connection id "+e+" (reason = "+t+")");return}n.info("connection destroyed: "+e+", reason = "+t);for(var r in l[e].streams){var i=l[e].streams[r];w(r,i)}delete l[e]}function b(e,t){var r={},o=t.connection.connectionId;if(!l[o]){n.info('race-condition: "streamCreated" called before "connectionCreated". Handling it.'),l[o].pending||(l[o]={pending:{}}),l[o].pending[e]=t;return}var u=l[o].local,f;switch(t.videoType){case"screen":f=u?"screenshare-local":"screenshare-remote";break;case"camera":f=u?"video-primary":"video-secondary";break;default:n.error('Unknown stream type "'+t.videoType+'", conn_id: '+o+", stream_id: "+e),f="video-secondary"}var h=i.get_container(f);if(!h){a.notify.alert("Internal TODO message","Ran out of containers ! Implement audio only containers.","danger",{non_dismissable:!1,button:{cancel:function(){}}});return}h.set_connection_id(o),c[e]={connection_id:o},l[o].streams[e]={stream:t,container:h},s.subscribe(t,h.div(),r).then(function(){i.reveal_video(h)},function(e){i.show_error(h,e)})}function w(e,t){if(!c[e])return;var r=c[e].connection_id,s=l[r].streams[e].container;n.info("stream destroyed: stream_id: "+e+", reason = "+t),i.giveup_container(s,t),delete l[r].streams[e],delete c[e]}var t=e("jquery"),n=e("log")("av-session","info"),r=e("./local-media"),i=e("./layout"),s=e("./tokbox"),o={},u,a,f={sessionConnected:p,sessionDisconnected:d,sessionReconnecting:v,sessionReconnected:m,connectionCreated:g,connectionDestroyed:y,streamCreated:b,streamDestroyed:w};o.init=function(e,t,n){return s.set_exception_handler(h),null},o.start=function(e,n){var o=t.Deferred();u=n,a=e;var l=i.get_container("video-primary");return s.init(n).then(s.set_handlers.bind(s,f),o.reject.bind(o)).then(s.connect,o.reject.bind(o)).then(r.init.bind(null,e,l),o.reject.bind(o)).then(r.start,o.reject.bind(o)),o.promise()},o.info=function(e,t,r){n.info("TODO : session.info called but not implemented")};var l={},c={};return o}),define("screenshare",["require","jquery","log","./layout","./tokbox"],function(e){function f(){var e=t.Deferred();return i.checkScreenSharingCapability(function(t){!t.supported||t.extensionRegistered===!1?e.reject("screensharing not supported"):t.extensionInstalled===!1?e.resolve(!1):e.resolve(!0)}),e.promise()}function l(){var e=o.identity.vc_id,t=r.get_container("screenshare-local");i.init_publisher(e,null,t.div(),{videoSource:"screen"}).then(function(e,n){a=n,i.publish(a),r.reveal_video(t)},function(e){n.error("screenshare: failed to initialize publisher: "+e)})}function h(e){var n="https://chrome.google.com/webstore/detail/"+u.chromeextensionid;c=t("[data-remodal-id=browser-extension-download]").remodal({closeOnConfirm:!1}),t("a[href='chromeSSExtPath']").attr("href",n),c.open()}function p(){c.close()}var t=e("jquery"),n=e("log")("av-screenshare","info"),r=e("./layout"),i=e("./tokbox"),s={},o,u,a;s.init=function(e,n){return o=e,u=n,t(".remodal-confirm").click(p),t("#widget-nav li#nav-screenshare a").on("click",s.start),null},s.start=function(){var e=t.Deferred();return i.registerScreenSharingExtension("chrome",u.chromeextensionid),f().then(function(t){if(t)return e.resolve(),l();h(e)},function(t){o.notify.alert("Screenshare Error",t,"danger",{non_dismissable:!0,button:{}}),e.reject(t)}),e.promise()};var c;return s}),define("av-tokbox-v2",["require","jquery","jade","log","framework","./session","./layout","./screenshare","./container-pool"],function(e){var t=e("jquery");window.jade=e("jade");var n=e("log")("av-main-v2","info"),r=e("framework"),i=e("./session"),s=e("./layout"),o=e("./screenshare"),u=e("./container-pool"),a={},f=r.handle("av-tokbox-v2");return a.init=function(e,n,r){var a=t.Deferred(),l=s.init(f,e,n,r);return l?(d.reject(l),d.promise()):(l=i.init(),l?(d.reject(l),d.promise()):(u.init(f,e,n,r),l=o.init(f,n),l?(d.reject(l),d.promise()):(a.resolve(),a.promise())))},a.start=function(e){return i.start(f,e)},a.info=function(e,t,n){},a}),require([""]);